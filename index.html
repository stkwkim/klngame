// 平滑滾動
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        
        const targetId = this.getAttribute('href');
        if(targetId === '#') return;
        
        const targetElement = document.querySelector(targetId);
        if(targetElement) {
            window.scrollTo({
                top: targetElement.offsetTop - 80,
                behavior: 'smooth'
            });
        }
    });
});

// 初始化本地存儲中的憑證
function initializeCredentials() {
    if (!localStorage.getItem('credentials')) {
        const defaultCredentials = [
            { phone: '13800138000', code: '123456' },
            { phone: '13900139000', code: '654321' },
            { phone: '13700137000', code: '888888' }
        ];
        localStorage.setItem('credentials', JSON.stringify(defaultCredentials));
        console.log('已初始化預設憑證');
    }
    updateCredentialsList();
}

// 更新憑證列表顯示
function updateCredentialsList() {
    const credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
    const credentialsList = document.getElementById('credentialsList');
    
    if (credentials.length === 0) {
        credentialsList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7);">暫無憑證</div>';
        return;
    }
    
    credentialsList.innerHTML = '';
    
    credentials.forEach((cred, index) => {
        const item = document.createElement('div');
        item.className = 'credential-item';
        item.innerHTML = `
            <span style="font-family: monospace;">${cred.phone}</span>
            <span style="font-family: monospace; margin: 0 10px;">/ ${cred.code}</span>
            <button class="delete-btn" data-index="${index}">刪除</button>
        `;
        credentialsList.appendChild(item);
    });
    
    // 添加刪除事件監聽
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            if (confirm('確定要刪除此憑證嗎？')) {
                deleteCredential(index);
            }
        });
    });
}

// 刪除憑證
function deleteCredential(index) {
    const credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
    credentials.splice(index, 1);
    localStorage.setItem('credentials', JSON.stringify(credentials));
    updateCredentialsList();
    showMessage('憑證已刪除', 'success');
}

// 添加新憑證
function addCredential(phone, code) {
    const credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
    
    // 檢查是否已存在相同手機號碼
    if (credentials.some(cred => cred.phone === phone)) {
        showMessage('該手機號碼已存在！', 'error');
        return false;
    }
    
    credentials.push({ phone, code });
    localStorage.setItem('credentials', JSON.stringify(credentials));
    updateCredentialsList();
    showMessage('憑證添加成功', 'success');
    return true;
}

// 驗證登入憑證
function validateLogin(phone, code) {
    const credentials = JSON.parse(localStorage.getItem('credentials') || '[]');
    const isValid = credentials.some(cred => cred.phone === phone && cred.code === code);
    
    if (isValid) {
        console.log('登入驗證成功:', phone);
    } else {
        console.log('登入驗證失敗:', phone, code);
        console.log('可用憑證:', credentials);
    }
    
    return isValid;
}

// 管理員登入
function adminLogin(username, password) {
    const isAdmin = username === 'admin' && password === 'admin88888888';
    if (isAdmin) {
        console.log('管理員登入成功');
    }
    return isAdmin;
}

// 顯示提示訊息
function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        ${type === 'success' ? 'background: #4caf50;' : ''}
        ${type === 'error' ? 'background: #f44336;' : ''}
        ${type === 'info' ? 'background: #2196f3;' : ''}
    `;
    messageDiv.textContent = message;
    
    // 添加動畫樣式
    if (!document.getElementById('messageStyles')) {
        const style = document.createElement('style');
        style.id = 'messageStyles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(messageDiv);
    
    // 3秒後自動移除
    setTimeout(() => {
        messageDiv.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

// 顯示報名頁面
function showRegistrationPage() {
    document.getElementById('registrationPage').style.display = 'flex';
}

// 隱藏報名頁面
function hideRegistrationPage() {
    document.getElementById('registrationPage').style.display = 'none';
}

// 更新禮物資訊
function updateGiftInfo() {
    const participants = document.getElementById('regParticipants').value;
    const giftInfo = document.getElementById('giftInfo');
    const giftCount = document.getElementById('giftCount');
    
    if (participants) {
        giftCount.textContent = participants;
        giftInfo.style.display = 'block';
    } else {
        giftInfo.style.display = 'none';
    }
}

// 發送郵件功能
function sendEmail(formData) {
    const email = 'stkwkim@gmail.com';
    const subject = '香港城市解謎報名表';
    
    // 構建郵件內容 - 使用UTF-8編碼
    let body = '香港城市解謎報名資料：%0D%0A%0D%0A';
    body += `主要聯絡人姓名：${encodeURIComponent(formData.name)}%0D%0A`;
    body += `手機號碼：${encodeURIComponent(formData.phone)}%0D%0A`;
    body += `電子郵件：${encodeURIComponent(formData.email)}%0D%0A`;
    body += `參與人數：${encodeURIComponent(formData.participants)}%0D%0A`;
    
    if (formData.otherParticipants) {
        body += `其他參加者資料：%0D%0A${encodeURIComponent(formData.otherParticipants)}%0D%0A`;
    }
    
    body += `選擇日期：${encodeURIComponent(formData.date)}%0D%0A`;
    body += `禮物數量：${encodeURIComponent(formData.participants)}份%0D%0A%0D%0A`;
    body += `提交時間：${encodeURIComponent(new Date().toLocaleString('zh-HK'))}`;
    
    // 使用mailto鏈接
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${body}`;
    
    // 在新窗口打開郵件客戶端
    window.open(mailtoLink, '_blank');
}

// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeCredentials();
    console.log('頁面載入完成，憑證系統已初始化');
    
    // 報名按鈕事件
    const registerButtons = [
        'registerBtn', 'heroRegisterBtn', 'introRegisterBtn', 'registerLink'
    ];
    
    registerButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                showRegistrationPage();
            });
        }
    });
    
    // 案件報名按鈕
    document.querySelectorAll('.case-register-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            showRegistrationPage();
        });
    });
    
    // 關閉報名頁面
    document.getElementById('closeRegistration').addEventListener('click', function() {
        hideRegistrationPage();
    });
    
    // 點擊背景也能關閉
    document.getElementById('registrationPage').addEventListener('click', function(e) {
        if (e.target === this) {
            hideRegistrationPage();
        }
    });
    
    // 參與人數變化事件
    document.getElementById('regParticipants').addEventListener('change', function() {
        const participants = this.value;
        const otherParticipantsGroup = document.getElementById('otherParticipantsGroup');
        
        if (participants > 1) {
            otherParticipantsGroup.style.display = 'block';
        } else {
            otherParticipantsGroup.style.display = 'none';
        }
        
        updateGiftInfo();
    });
    
    // 提交報名
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('regName').value,
            phone: document.getElementById('regPhone').value,
            email: document.getElementById('regEmail').value,
            participants: document.getElementById('regParticipants').value,
            otherParticipants: document.getElementById('otherParticipants').value,
            date: document.getElementById('regDate').value
        };
        
        // 驗證必填欄位
        const requiredFields = ['name', 'phone', 'email', 'participants', 'date'];
        for (let field of requiredFields) {
            if (!formData[field]) {
                showMessage('請填寫所有必填欄位', 'error');
                document.getElementById(`reg${field.charAt(0).toUpperCase() + field.slice(1)}`).focus();
                return;
            }
        }
        
        // 驗證手機號碼格式（香港）
        const phoneRegex = /^(5|6|9)\d{7}$/;
        if (!phoneRegex.test(formData.phone)) {
            showMessage('請輸入有效的香港手機號碼（8位數字，以5、6或9開頭）', 'error');
            document.getElementById('regPhone').focus();
            return;
        }
        
        // 驗證電子郵件
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            showMessage('請輸入有效的電子郵件地址', 'error');
            document.getElementById('regEmail').focus();
            return;
        }
        
        // 驗證日期（不能選擇過去日期）
        const selectedDate = new Date(formData.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            showMessage('請選擇今天或之後的日期', 'error');
            document.getElementById('regDate').focus();
            return;
        }
        
        // 如果有其他參加者但未填寫資料
        if (formData.participants > 1 && !formData.otherParticipants) {
            showMessage('請填寫其他參加者資料', 'error');
            document.getElementById('otherParticipants').focus();
            return;
        }
        
        // 發送郵件
        try {
            sendEmail(formData);
            showMessage('報名成功！郵件客戶端已打開，請發送確認郵件。', 'success');
            setTimeout(() => {
                hideRegistrationPage();
                // 清空表單
                document.getElementById('registrationForm').reset();
                document.getElementById('otherParticipantsGroup').style.display = 'none';
                document.getElementById('giftInfo').style.display = 'none';
            }, 2000);
        } catch (error) {
            showMessage('報名成功！我們將在24小時內與您聯繫確認詳情。', 'success');
            setTimeout(() => {
                hideRegistrationPage();
                // 清空表單
                document.getElementById('registrationForm').reset();
                document.getElementById('otherParticipantsGroup').style.display = 'none';
                document.getElementById('giftInfo').style.display = 'none';
            }, 2000);
        }
    });
    
    // 普通用戶登入
    document.getElementById('loginBtn').addEventListener('click', function() {
        const phone = document.getElementById('phone').value.trim();
        const code = document.getElementById('code').value.trim();
        
        if (!phone || !code) {
            showMessage('請填寫所有欄位', 'error');
            return;
        }
        
        if (validateLogin(phone, code)) {
            showMessage('登入成功！正在進入遊戲...', 'success');
            // 延遲跳轉，讓用戶看到成功訊息
            setTimeout(() => {
                console.log('正在跳轉到 game.html...');
                window.location.href = './game.html';
            }, 1500);
        } else {
            showMessage('手機號碼或驗證碼錯誤，請重試', 'error');
            // 清空驗證碼欄位
            document.getElementById('code').value = '';
            document.getElementById('code').focus();
        }
    });
    
    // 按Enter鍵登入
    document.getElementById('code').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('loginBtn').click();
        }
    });
    
    // 管理員面板切換
    document.getElementById('adminToggle').addEventListener('click', function() {
        const panel = document.getElementById('adminPanel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });
    
    // 管理員登入
    document.getElementById('adminLogin').addEventListener('click', function() {
        const username = document.getElementById('adminUser').value.trim();
        const password = document.getElementById('adminPass').value.trim();
        
        if (!username || !password) {
            showMessage('請填寫管理員帳號和密碼', 'error');
            return;
        }
        
        if (adminLogin(username, password)) {
            document.getElementById('adminControls').style.display = 'block';
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
            showMessage('管理員登入成功', 'success');
        } else {
            showMessage('管理員帳號或密碼錯誤', 'error');
            document.getElementById('adminPass').value = '';
            document.getElementById('adminPass').focus();
        }
    });
    
    // 管理員登出
    document.getElementById('adminLogout').addEventListener('click', function() {
        document.getElementById('adminControls').style.display = 'none';
        showMessage('管理員已登出', 'info');
    });
    
    // 添加新憑證
    document.getElementById('addCredential').addEventListener('click', function() {
        const phone = document.getElementById('newPhone').value.trim();
        const code = document.getElementById('newCode').value.trim();
        
        if (!phone || !code) {
            showMessage('請填寫手機號碼和驗證碼', 'error');
            return;
        }
        
        // 驗證手機號碼格式
        const phoneRegex = /^\d{8,11}$/;
        if (!phoneRegex.test(phone)) {
            showMessage('請輸入有效的手機號碼（8-11位數字）', 'error');
            document.getElementById('newPhone').focus();
            return;
        }
        
        // 驗證驗證碼格式
        if (code.length < 4) {
            showMessage('驗證碼至少需要4位數字', 'error');
            document.getElementById('newCode').focus();
            return;
        }
        
        if (addCredential(phone, code)) {
            // 清空輸入欄位
            document.getElementById('newPhone').value = '';
            document.getElementById('newCode').value = '';
            document.getElementById('newPhone').focus();
        }
    });
    
    // 憑證輸入欄位按Enter鍵快速添加
    document.getElementById('newCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('addCredential').click();
        }
    });
    
    // 清空登入欄位
    const loginInputs = ['phone', 'code'];
    loginInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('focus', function() {
                this.value = '';
            });
        }
    });
});
